<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HMI Enchapadora V2.1.1</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;500&display=swap"
        rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>

    <style>
        body {
            background-color: #0d0d0d;
            color: #e0e0e0;
            font-family: 'Roboto', sans-serif;
            overflow: hidden;
        }

        .header-panel {
            background: linear-gradient(180deg, #1a1a1a 0%, #000 100%);
            border-bottom: 2px solid #333;
            padding: 10px;
        }

        .status-display {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            color: #00ff00;
            text-shadow: 0 0 10px #00ff0055;
        }

        .card-industrial {
            background: #151515;
            border: 1px solid #333;
            border-radius: 8px;
            margin-bottom: 10px;
            padding: 15px;
        }

        .text-label {
            color: #b0b0b0;
            font-size: 0.85rem;
            font-weight: 500;
            text-transform: uppercase;
            margin-bottom: 5px;
            display: block;
        }

        .btn-toggle {
            width: 100%;
            padding: 15px;
            font-weight: bold;
            text-transform: uppercase;
            border-radius: 10px;
            transition: 0.3s;
        }

        .bg-active {
            background-color: #00ff00 !important;
            color: #000;
            box-shadow: 0 0 15px #00ff0088;
        }

        .bg-inactive {
            background-color: #222 !important;
            color: #aaa;
            border: 1px solid #444;
        }

        .bg-ocupada {
            background-color: #ff9900 !important;
            color: #000;
            animation: pulse 2s infinite;
        }

        .bg-danger-flash {
            background-color: #ff0000;
            color: white;
            animation: flash 1s infinite;
        }

        @keyframes flash {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.4;
            }

            100% {
                opacity: 1;
            }
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }

            100% {
                opacity: 1;
            }
        }

        .temp-display {
            font-size: 3rem;
            font-family: 'Orbitron', sans-serif;
            text-align: center;
        }

        .indicator-led {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
            vertical-align: middle;
            transition: background-color 0.2s;
        }

        .io-text {
            font-size: 0.8rem;
            color: #ccc;
            margin-bottom: 2px;
        }
    </style>
</head>

<body>

    <div class="container-fluid">
        <div class="row header-panel align-items-center">
            <div class="col-4">
                <span class="text-white small">SISTEMA ENCHAPADORA V2.1.1</span><br>
                <span id="txt-mando" class="badge bg-inactive">TENSIÓN DE MANDO OFF</span>
            </div>
            <div class="col-4 text-center">
                <div id="reloj" class="status-display">00:00:00</div>
            </div>
            <div class="col-4 text-end">
                <span id="badge-ocupada" class="badge bg-inactive me-2">LIBRE</span>
                <button id="btn-mando" class="btn btn-outline-success" onclick="toggleMando()">CONECTAR MANDO</button>
            </div>
        </div>

        <div id="banner-emergencia" class="row bg-danger-flash d-none py-2 text-center fw-bold">
            <span id="msg-error">¡PARO DE EMERGENCIA ACTIVADO!</span>
            <button class="btn btn-sm btn-light ms-3" onclick="resetEmergencia()"
                style="width: auto; display: inline-block;">REARMAR</button>
        </div>

        <div class="row mt-3">
            <div class="col-7">
                <div class="row g-2">
                    <div class="col-6">
                        <button id="btn-cadena" class="btn btn-toggle bg-inactive" onclick="comando('cadena')">Cadena
                            Avance</button>
                    </div>
                    <div class="col-6">
                        <button id="btn-fresador" class="btn btn-toggle bg-inactive" onclick="comando('fresador')">Grupo
                            Fresa</button>
                    </div>
                    <div class="col-6">
                        <button id="btn-alimentador" class="btn btn-toggle bg-inactive"
                            onclick="comando('alimentador')">Aliment/Guilloti</button>
                    </div>
                    <div class="col-6">
                        <button id="btn-retestador" class="btn btn-toggle bg-inactive"
                            onclick="comando('retestador')">Retestador</button>
                    </div>
                    <div class="col-6">
                        <button id="btn-refilador" class="btn btn-toggle bg-inactive"
                            onclick="comando('refilador')">Refilador</button>
                    </div>
                    <div class="col-6">
                        <button id="btn-calefaccion" class="btn btn-toggle bg-inactive"
                            onclick="comando('calefaccion')">Calefacción</button>
                    </div>
                </div>

                <div class="card-industrial mt-3">
                    <label class="text-label">POSICIÓN PIEZA (ENCODER)</label>
                    <div class="progress mt-1" style="height: 25px; background: #000;">
                        <div id="progreso-pieza"
                            class="progress-bar bg-success progress-bar-striped progress-bar-animated"
                            style="width: 0%"></div>
                    </div>
                    <div class="d-flex justify-content-between mt-1 text-white">
                        <span id="val-posicion">0 mm</span>
                        <span id="val-longitud">Largo: 0 mm</span>
                    </div>
                </div>
            </div>

            <div class="col-5">
                <div class="card-industrial text-center">
                    <label class="text-label">TEMPERATURA COLA</label>
                    <div id="val-temp" class="temp-display text-warning">0.0°C</div>
                    <div class="text-white">SETPOINT: 180°C</div>
                </div>

                <div class="card-industrial">
                    <label class="text-label mb-2 text-center border-bottom pb-1 border-secondary">MONITOR I/O</label>
                    <div class="row">
                        <div class="col-6 border-end border-secondary">
                            <label class="text-label" style="font-size:0.7rem;">ENTRADAS</label>
                            <div class="io-text"><span id="in-sensor" class="indicator-led bg-inactive"></span> SENSOR
                                ENT</div>
                            <div class="io-text"><span id="in-paro1" class="indicator-led bg-inactive"></span> PARO ENT
                                (NC)</div>
                            <div class="io-text"><span id="in-paro2" class="indicator-led bg-inactive"></span> PARO SAL
                                (NC)</div>
                        </div>
                        <div class="col-6">
                            <label class="text-label" style="font-size:0.7rem;">SALIDAS</label>
                            <div class="io-text"><span id="led-cadena" class="indicator-led bg-inactive"></span> CADENA
                            </div>
                            <div class="io-text"><span id="led-fresas-motor" class="indicator-led bg-inactive"></span>
                                M. FRESA</div>
                            <div class="io-text"><span id="led-fresas-ev1" class="indicator-led bg-inactive"></span> EV
                                FRESA 1</div>
                            <div class="io-text"><span id="led-fresas-ev2" class="indicator-led bg-inactive"></span> EV
                                FRESA 2</div>
                            <div class="io-text"><span id="led-alimen" class="indicator-led bg-inactive"></span>
                                ALIMENT.</div>
                            <div class="io-text"><span id="led-guillo" class="indicator-led bg-inactive"></span>
                                GUILLOT.</div>
                            <div class="io-text"><span id="led-retest" class="indicator-led bg-inactive"></span> M.
                                RETEST</div>
                            <div class="io-text"><span id="led-refil" class="indicator-led bg-inactive"></span> M. REFIL
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="banner-temp-baja" class="fixed-bottom bg-warning text-dark text-center py-1 fw-bold d-none"
        style="opacity: 0.9; z-index: 1050; animation: pulse 2s infinite;">
        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
        Temperatura de aplicación baja, por favor espere...
    </div>

    <script>
        const socket = io();
        let estadoActual = {};

        function toggleMando() {
            const nuevoEstado = !estadoActual.tension_mando;
            socket.emit('comando_control', { tipo: 'tension_mando', valor: nuevoEstado });
        }

        function resetEmergencia() {
            socket.emit('comando_control', { tipo: 'reset_emergencia' });
        }

        function comando(grupo) {
            const campo = "habil_" + grupo;
            socket.emit('comando_control', { tipo: grupo, valor: !estadoActual[campo] });
        }

        function updateLed(id, isActive) {
            const element = document.getElementById(id);
            if (isActive) {
                element.classList.replace('bg-inactive', 'bg-active');
            } else {
                element.classList.replace('bg-active', 'bg-inactive');
            }
        }

        socket.on('update_status', function (data) {
            estadoActual = data;

            // 1. Emergencia
            const banner = document.getElementById('banner-emergencia');
            if (data.emergencia) {
                banner.classList.remove('d-none');
                document.getElementById('msg-error').innerText = data.mensaje_error;
            } else {
                banner.classList.add('d-none');
            }

            // 2. Tensión de Mando
            const btnMando = document.getElementById('btn-mando');
            const txtMando = document.getElementById('txt-mando');
            if (data.tension_mando) {
                btnMando.innerText = "DESCONECTAR MANDO";
                btnMando.classList.replace('btn-outline-success', 'btn-danger');
                txtMando.innerText = "SISTEMA LISTO (ON)";
                txtMando.classList.replace('bg-inactive', 'bg-success');
            } else {
                btnMando.innerText = "CONECTAR MANDO";
                btnMando.classList.replace('btn-danger', 'btn-outline-success');
                txtMando.innerText = "TENSIÓN DE MANDO OFF";
                txtMando.classList.replace('bg-success', 'bg-inactive');
            }

            // 3. Estado Máquina Ocupada
            const badgeOcupada = document.getElementById('badge-ocupada');
            if (data.maquina_ocupada) {
                badgeOcupada.innerText = "MÁQUINA OCUPADA";
                badgeOcupada.classList.replace('bg-inactive', 'bg-ocupada');
            } else {
                badgeOcupada.innerText = "LIBRE";
                badgeOcupada.classList.remove('bg-ocupada');
                badgeOcupada.classList.add('bg-inactive');
            }

            // 4. Advertencia de Temperatura (NO invasivo)
            const bannerTemp = document.getElementById('banner-temp-baja');
            if (data.habil_calefaccion && data.temp_actual < data.temp_objetivo && !data.emergencia) {
                bannerTemp.classList.remove('d-none');
            } else {
                bannerTemp.classList.add('d-none');
            }

            // 5. Botones Habilitadores
            const grupos = ['cadena', 'fresador', 'alimentador', 'retestador', 'refilador', 'calefaccion'];
            grupos.forEach(g => {
                const btn = document.getElementById('btn-' + g);
                if (data['habil_' + g]) btn.classList.replace('bg-inactive', 'bg-active');
                else btn.classList.replace('bg-active', 'bg-inactive');
            });

            // 6. MONITOR ENTRADAS (1=Activo por lógica de pulsador invertido, Paros: 1=OK)
            updateLed('in-sensor', data.in_sensor_entrada === 1);
            updateLed('in-paro1', data.in_paro_entrada === 1);
            updateLed('in-paro2', data.in_paro_salida === 1);

            // 7. MONITOR SALIDAS (Usando helper para inyectar CSS correctamente)
            updateLed('led-cadena', data.act_cadena);
            updateLed('led-fresas-motor', data.act_fresador);
            updateLed('led-fresas-ev1', data.act_fresa1);
            updateLed('led-fresas-ev2', data.act_fresa2);
            updateLed('led-alimen', data.act_alimentador);
            updateLed('led-guillo', data.act_guillotina);
            updateLed('led-retest', data.act_retestador);
            updateLed('led-refil', data.act_refilador);

            // 8. Valores
            document.getElementById('val-temp').innerText = data.temp_actual.toFixed(1) + "°C";
            document.getElementById('val-posicion').innerText = Math.round(data.encoder_pos) + " mm";
            document.getElementById('val-longitud').innerText = "Largo: " + Math.round(data.longitud_pieza) + " mm";

            const pct = (data.encoder_pos / 1500) * 100;
            document.getElementById('progreso-pieza').style.width = pct + "%";
        });

        setInterval(() => {
            document.getElementById('reloj').innerText = new Date().toLocaleTimeString();
        }, 1000);
    </script>

</body>

</html>